<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أكاديمية الأمة | Ummah Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; scroll-behavior: smooth; }
        .hero-gradient { background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1574629810360-7efbbe195018?auto=format&fit=crop&q=80'); background-size: cover; background-position: center; }
        .loading-spinner { border-top-color: #ef4444; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .logo-container { width: 65px; height: 65px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 9999px; background: white; }
        .logo-img { height: 100%; width: 100%; object-fit: cover; }
        .slot-available { background: #f0fdf4; color: #166534; border: 1px solid #bcf0da; cursor: pointer; }
        .slot-booked { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; cursor: not-allowed; opacity: 0.6; }
        .slot-selected { background: #4338ca !important; color: white !important; border-color: #4338ca !important; }
        .admin-modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); }
        .payment-modal { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white z-[9999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-slate-200 loading-spinner rounded-full mb-4"></div>
        <p class="font-bold text-indigo-900">جاري تحميل نظام الأكاديمية...</p>
    </div>

    <!-- Navigation -->
    <nav class="sticky top-0 w-full z-50 bg-white/95 backdrop-blur-md shadow-md border-b border-slate-100">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center">
                <div class="logo-container border shadow-sm">
                    <img src="https://lh3.googleusercontent.com/d/1FFfUtXRmf5VCQ7RsQQyoDrbuOIgeCoaD" alt="Logo" class="logo-img">
                </div>
                <div class="mr-3">
                    <span class="text-indigo-900 font-black text-xl block leading-none">أكاديمية الأمة</span>
                    <span class="text-slate-500 font-bold text-[10px] uppercase">Ummah Academy</span>
                </div>
            </div>
            <div class="hidden md:flex space-x-6 space-x-reverse font-bold text-sm">
                <a href="#home" class="hover:text-red-600">الرئيسية</a>
                <a href="#booking" class="hover:text-red-600">حجز الملعب</a>
                <a href="#academy" class="hover:text-red-600">تسجيل لاعب</a>
                <a href="#archive" class="hover:text-red-600">الأرشيف</a>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleAdminModal(true)" class="text-slate-400 hover:text-indigo-900 transition-colors">
                    <i class="fas fa-user-shield text-xl"></i>
                </button>
                <button onclick="document.getElementById('booking').scrollIntoView()" class="bg-indigo-900 text-white px-6 py-2 rounded-xl font-bold text-sm">احجز الآن</button>
            </div>
        </div>
    </nav>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="fixed inset-0 z-[100] admin-modal hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2rem] p-8 shadow-2xl relative">
            <button onclick="toggleAdminModal(false)" class="absolute left-6 top-6 text-slate-300 hover:text-red-500 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-100 text-indigo-900 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-lock text-2xl"></i>
                </div>
                <h3 class="text-2xl font-black text-indigo-900">دخول الإدارة</h3>
            </div>
            <div class="space-y-4">
                <input type="text" id="adminUser" placeholder="اسم المستخدم" class="w-full px-4 py-4 rounded-xl border bg-slate-50 outline-none">
                <input type="password" id="adminPass" placeholder="كلمة المرور" class="w-full px-4 py-4 rounded-xl border bg-slate-50 outline-none">
                <button onclick="window.handleAdminLogin()" class="w-full bg-indigo-900 text-white py-4 rounded-xl font-bold text-lg">دخول</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="fixed inset-0 z-[200] bg-slate-100 hidden overflow-y-auto pb-20">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <div class="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm">
                <h2 class="text-2xl font-black text-indigo-900">لوحة التحكم</h2>
                <button onclick="logoutAdmin()" class="bg-red-500 text-white px-6 py-2 rounded-xl font-bold">خروج</button>
            </div>
            
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl border">
                    <h3 class="font-black mb-4 text-indigo-900 border-b pb-2">حجوزات الملعب</h3>
                    <div id="adminBookingContent" class="space-y-3 text-right"></div>
                </div>
                <div class="bg-white p-6 rounded-2xl border">
                    <h3 class="font-black mb-4 text-green-700 border-b pb-2">اللاعبين المشتركين</h3>
                    <div id="adminPlayerContent" class="space-y-3 text-right"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="fixed inset-0 z-[1000] payment-modal hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl relative text-center">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-credit-card text-3xl"></i>
            </div>
            <h3 class="text-2xl font-black text-indigo-900 mb-2">بوابة الدفع المصرفي</h3>
            <p class="text-slate-500 mb-6 text-sm">أدخل بيانات البطاقة لإتمام العملية بأمان</p>
            
            <div class="space-y-4 text-right">
                <div>
                    <label class="text-xs font-bold text-slate-400 mr-2">رقم البطاقة</label>
                    <input type="text" id="cardNumber" placeholder="**** **** **** ****" class="w-full p-4 rounded-xl border bg-slate-50 text-center tracking-widest font-mono">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 mr-2">تاريخ الانتهاء</label>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" class="w-full p-4 rounded-xl border bg-slate-50 text-center">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 mr-2">رمز الـ CVV</label>
                        <input type="password" id="cardCvv" placeholder="***" class="w-full p-4 rounded-xl border bg-slate-50 text-center">
                    </div>
                </div>
                <button id="payConfirmBtn" onclick="window.completeTransaction()" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black text-xl shadow-lg mt-4 disabled:bg-slate-300">تأكيد الدفع</button>
                <button onclick="togglePaymentModal(false)" class="w-full text-slate-400 font-bold py-2">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- Hero -->
    <section id="home" class="hero-gradient min-h-[70vh] flex items-center justify-center text-center text-white px-4">
        <div class="max-w-3xl">
            <h1 class="text-4xl md:text-6xl font-black mb-6 italic underline decoration-red-600">أكاديمية الأمة</h1>
            <p class="text-xl text-slate-200 mb-8">نصنع أبطال الغد بمدربين محترفين ومرافق عالمية.</p>
            <div class="flex flex-wrap justify-center gap-4">
                <a href="#booking" class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-2xl font-black transition">حجز ملعب</a>
                <a href="#academy" class="bg-white text-indigo-900 px-8 py-3 rounded-2xl font-black transition">تسجيل لاعب</a>
            </div>
        </div>
    </section>

    <!-- Academy Registration -->
    <section id="academy" class="py-20 px-4 bg-indigo-50">
        <div class="container mx-auto max-w-4xl">
            <div class="bg-white rounded-[3rem] shadow-xl overflow-hidden border border-indigo-100 flex flex-col md:flex-row">
                <div class="md:w-2/5 bg-indigo-900 p-10 text-white">
                    <h2 class="text-3xl font-black mb-6 italic">انضم إلينا</h2>
                    <ul class="space-y-4 text-indigo-100 text-sm">
                        <li><i class="fas fa-check-circle ml-2 text-green-400"></i> تدريبات يومية مكثفة</li>
                        <li><i class="fas fa-check-circle ml-2 text-green-400"></i> أرشيف فيديوهات لكل لاعب</li>
                        <li><i class="fas fa-check-circle ml-2 text-green-400"></i> مدربون معتمدون دولياً</li>
                        <li><i class="fas fa-check-circle ml-2 text-green-400"></i> مباريات ودية أسبوعية</li>
                    </ul>
                </div>
                <div class="md:w-3/5 p-10">
                    <h3 class="text-2xl font-black mb-6 text-indigo-900">بيانات اللاعب الجديد</h3>
                    <div class="grid gap-4">
                        <input type="text" id="playerName" placeholder="اسم اللاعب بالكامل" class="w-full p-4 rounded-xl border bg-slate-50">
                        <input type="number" id="playerAge" placeholder="العمر" class="w-full p-4 rounded-xl border bg-slate-50">
                        <input type="tel" id="playerParentPhone" placeholder="رقم هاتف ولي الأمر" class="w-full p-4 rounded-xl border bg-slate-50">
                        <select id="playerLevel" class="w-full p-4 rounded-xl border bg-slate-50">
                            <option value="beginner">مبتدئ</option>
                            <option value="intermediate">متوسط</option>
                            <option value="advanced">متقدم</option>
                        </select>
                        <button onclick="window.startPayment('player')" class="bg-indigo-900 text-white py-4 rounded-2xl font-black mt-4 shadow-lg hover:bg-indigo-800 transition">التسجيل والدفع</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Booking Section -->
    <section id="booking" class="py-20 px-4">
        <div class="container mx-auto max-w-5xl">
            <div class="bg-white rounded-[3rem] shadow-xl p-8 md:p-12 border border-slate-100">
                <h2 class="text-3xl font-black text-center mb-10 italic text-indigo-900">احجز ملعبك الآن</h2>
                <div class="grid md:grid-cols-2 gap-12 text-right">
                    <div class="space-y-4">
                        <label class="block font-bold text-slate-700">التاريخ:</label>
                        <input type="date" id="targetDate" onchange="window.checkAvailability()" class="w-full p-4 rounded-xl border bg-slate-50">
                        <input type="text" id="resName" placeholder="اسم صاحب الحجز" class="w-full p-4 rounded-xl border bg-slate-50">
                        <input type="tel" id="resPhone" placeholder="رقم الهاتف" class="w-full p-4 rounded-xl border bg-slate-50">
                    </div>
                    <div>
                        <label class="block font-bold text-slate-700 mb-4">الساعات المتاحة:</label>
                        <div id="timeGrid" class="grid grid-cols-2 gap-2 text-sm">
                            <p class="col-span-2 text-slate-400 text-center py-10">اختر التاريخ أولاً</p>
                        </div>
                    </div>
                </div>
                <button onclick="window.startPayment('booking')" class="w-full mt-10 bg-red-600 text-white py-5 rounded-2xl font-black text-xl shadow-xl hover:bg-red-700 transition">انتقل للدفع وتأكيد الحجز</button>
            </div>
        </div>
    </section>

    <!-- Archive Section -->
    <section id="archive" class="py-20 px-4 bg-slate-900 text-white">
        <div class="container mx-auto max-w-6xl">
            <h2 class="text-3xl font-black mb-12 italic border-r-4 border-red-600 pr-4">أرشيف الفيديوهات</h2>
            <div class="grid md:grid-cols-3 gap-6" id="archiveGrid">
                <div class="aspect-video bg-slate-800 rounded-2xl overflow-hidden relative group cursor-pointer">
                    <img src="https://images.unsplash.com/photo-1574629810360-7efbbe195018?auto=format&fit=crop&q=80" class="w-full h-full object-cover opacity-50 group-hover:scale-110 transition duration-500">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <i class="fas fa-play text-4xl group-hover:scale-125 transition text-red-500"></i>
                    </div>
                    <div class="absolute bottom-4 right-4 font-bold text-sm bg-black/50 px-3 py-1 rounded">مباراة الشباب - 01/01/2026</div>
                </div>
            </div>
        </div>
    </section>

    <div id="toast" class="fixed bottom-5 left-5 bg-indigo-900 text-white px-8 py-4 rounded-2xl shadow-2xl transform translate-y-20 opacity-0 transition-all z-[2000]">
        <p id="toastMsg" class="font-bold"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ummah-academy-app-v2';
        
        let db = null;
        let auth = null;
        let currentUser = null;
        let selectedTime = null;
        let pendingAction = null;

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 4000);
        };

        const hideLoading = () => {
            const overlay = document.getElementById('loadingOverlay');
            if(overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        };

        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if(user) {
                        hideLoading();
                        const dateVal = document.getElementById('targetDate').value;
                        if(dateVal) window.checkAvailability();
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                hideLoading();
            }
        };

        initFirebase();

        const getBookingCol = () => collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
        const getPlayerCol = () => collection(db, 'artifacts', appId, 'public', 'data', 'players');

        window.toggleAdminModal = (show) => document.getElementById('adminModal').style.display = show ? 'flex' : 'none';
        window.togglePaymentModal = (show) => document.getElementById('paymentModal').style.display = show ? 'flex' : 'none';

        window.handleAdminLogin = () => {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            if(user === 'admin' && pass === 'ummah2026'){
                document.getElementById('adminDashboard').classList.remove('hidden');
                toggleAdminModal(false);
                loadAdminData();
            } else {
                showToast("اسم المستخدم أو كلمة المرور غير صحيحة");
            }
        };

        window.logoutAdmin = () => document.getElementById('adminDashboard').classList.add('hidden');

        const loadAdminData = async () => {
            if(!db || !currentUser) return;
            try {
                const bSnap = await getDocs(getBookingCol());
                const bCont = document.getElementById('adminBookingContent');
                bCont.innerHTML = bSnap.empty ? '<p class="text-slate-400 text-center">لا توجد حجوزات</p>' : '';
                bSnap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    div.className = "p-3 bg-slate-50 rounded-lg flex justify-between items-center text-xs mb-2 border";
                    div.innerHTML = `<span>${data.date} | ${data.time} | ${data.name}</span><button onclick="window.deleteDoc('bookings', '${d.id}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>`;
                    bCont.appendChild(div);
                });

                const pSnap = await getDocs(getPlayerCol());
                const pCont = document.getElementById('adminPlayerContent');
                pCont.innerHTML = pSnap.empty ? '<p class="text-slate-400 text-center">لا يوجد لاعبين</p>' : '';
                pSnap.forEach(d => {
                    const data = d.data();
                    const div = document.createElement('div');
                    div.className = "p-3 bg-green-50 rounded-lg flex justify-between items-center text-xs mb-2 border border-green-100";
                    div.innerHTML = `<span>اللاعب: ${data.name} | عمر: ${data.age}</span><button onclick="window.deleteDoc('players', '${d.id}')" class="text-red-500 p-2"><i class="fas fa-trash"></i></button>`;
                    pCont.appendChild(div);
                });
            } catch (e) {
                showToast("خطأ في جلب البيانات");
            }
        };

        window.deleteDoc = async (type, id) => {
            if(!confirm("هل أنت متأكد من حذف هذا السجل؟")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', type, id));
                loadAdminData();
                showToast("تم الحذف بنجاح");
            } catch (e) {
                showToast("فشل الحذف");
            }
        };

        window.startPayment = (type) => {
            if(type === 'booking'){
                if(!document.getElementById('resName').value || !selectedTime || !document.getElementById('targetDate').value) {
                    return showToast("يرجى إكمال بيانات الحجز واختيار الساعة");
                }
                pendingAction = 'booking';
            } else {
                if(!document.getElementById('playerName').value || !document.getElementById('playerAge').value || !document.getElementById('playerParentPhone').value) {
                    return showToast("يرجى إكمال بيانات اللاعب قبل الدفع");
                }
                pendingAction = 'player';
            }
            togglePaymentModal(true);
        };

        window.completeTransaction = async () => {
            const btn = document.getElementById('payConfirmBtn');
            if(!currentUser || !db) return showToast("يرجى الانتظار، جاري الربط مع الخادم...");

            btn.disabled = true;
            btn.innerText = "جاري الحفظ...";
            
            try {
                if(pendingAction === 'booking'){
                    await addDoc(getBookingCol(), {
                        name: document.getElementById('resName').value,
                        phone: document.getElementById('resPhone').value,
                        date: document.getElementById('targetDate').value,
                        time: selectedTime,
                        type: 'stadium_booking',
                        createdAt: serverTimestamp()
                    });
                    showToast("تم الحجز والدفع بنجاح!");
                    document.getElementById('resName').value = "";
                    selectedTime = null;
                } else if(pendingAction === 'player'){
                    await addDoc(getPlayerCol(), {
                        name: document.getElementById('playerName').value,
                        age: document.getElementById('playerAge').value,
                        parentPhone: document.getElementById('playerParentPhone').value,
                        level: document.getElementById('playerLevel').value,
                        type: 'academy_registration',
                        createdAt: serverTimestamp()
                    });
                    showToast("تم تسجيل اللاعب بنجاح!");
                    document.getElementById('playerName').value = "";
                }
                
                togglePaymentModal(false);
                if(pendingAction === 'booking') window.checkAvailability();
                
            } catch (e) {
                console.error(e);
                showToast("حدث خطأ، تأكد من اتصالك بالإنترنت");
            } finally {
                btn.disabled = false;
                btn.innerText = "تأكيد الدفع";
            }
        };

        window.checkAvailability = () => {
            const dateInput = document.getElementById('targetDate').value;
            const grid = document.getElementById('timeGrid');
            if(!dateInput) return;
            
            grid.innerHTML = '<p class="col-span-2 text-center py-4 text-indigo-500 animate-pulse">جاري فحص المواعيد...</p>';
            
            if(!db || !currentUser) {
                setTimeout(window.checkAvailability, 1000);
                return;
            }

            // Use onSnapshot for real-time and more reliable connection on GitHub Pages
            const q = query(getBookingCol());
            onSnapshot(q, (snap) => {
                const bookedTimes = [];
                snap.forEach(doc => {
                    const data = doc.data();
                    if (data.date === dateInput) {
                        bookedTimes.push(data.time);
                    }
                });

                grid.innerHTML = '';
                const hours = ["18:00", "19:00", "20:00", "21:00", "22:00", "23:00", "00:00"];
                
                hours.forEach(time => {
                    const isBooked = bookedTimes.includes(time);
                    const btn = document.createElement('div');
                    btn.className = `p-4 rounded-xl text-center font-bold transition duration-300 ${isBooked ? 'slot-booked' : 'slot-available hover:shadow-md'}`;
                    btn.innerText = time;
                    
                    if(!isBooked) {
                        btn.onclick = () => {
                            document.querySelectorAll('.slot-available').forEach(el => el.classList.remove('slot-selected'));
                            btn.classList.add('slot-selected');
                            selectedTime = time;
                        };
                    }
                    grid.appendChild(btn);
                });
            }, (error) => {
                console.error("Listener Error:", error);
                grid.innerHTML = '<p class="col-span-2 text-red-500 text-center py-4">فشل جلب البيانات، يرجى تحديث الصفحة</p>';
            });
        };

    </script>
</body>
</html>
